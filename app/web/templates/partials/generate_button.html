{% set pid = project_id or id %}
<div id="generate-section">
  <form
    hx-post="/hx/projects/{{ pid }}/generate"
    hx-target="#pattern-results-card"
    hx-swap="outerHTML"
    hx-indicator="#generate-loading-{{ pid }}"
    hx-disabled-elt="#generate-btn-{{ pid }}">

    <div class="mb-3">
      <label for="num-colors-{{ pid }}" class="block text-xs text-gray-600 mb-1">
        Number of colors
      </label>
      <input
        id="num-colors-{{ pid }}"
        type="number"
        name="num_colors"
        value="10"
        min="2"
        max="{{ max_colors }}"
        class="w-full text-sm border border-gray-300 rounded-lg px-3 py-1.5
               focus:outline-none focus:ring-1 focus:ring-indigo-500" />
    </div>

    <div class="mb-4">
      <span class="block text-xs text-gray-600 mb-1">Target size (stitches)</span>
      <div class="flex gap-2">
        <div class="flex-1">
          <label for="target-width-{{ pid }}" class="block text-xs text-gray-400 mb-0.5">
            Width
          </label>
          <input
            id="target-width-{{ pid }}"
            type="number"
            name="target_width"
            value="{{ default_target_width }}"
            min="10"
            max="{{ max_target_width }}"
            class="w-full text-sm border border-gray-300 rounded-lg px-3 py-1.5
                   focus:outline-none focus:ring-1 focus:ring-indigo-500" />
        </div>
        <div class="flex-1">
          <label for="target-height-{{ pid }}" class="block text-xs text-gray-400 mb-0.5">
            Height
          </label>
          <input
            id="target-height-{{ pid }}"
            type="number"
            name="target_height"
            value="{{ default_target_height }}"
            min="10"
            max="{{ max_target_height }}"
            class="w-full text-sm border border-gray-300 rounded-lg px-3 py-1.5
                   focus:outline-none focus:ring-1 focus:ring-indigo-500" />
        </div>
      </div>
    </div>

    <div class="mb-4">
      <label for="processing-mode-{{ pid }}" class="block text-xs text-gray-600 mb-1">
        Image type
      </label>
      <select
        id="processing-mode-{{ pid }}"
        name="processing_mode"
        class="w-full text-sm border border-gray-300 rounded-lg px-3 py-1.5
               focus:outline-none focus:ring-1 focus:ring-indigo-500 bg-white">
        <option value="auto"      {% if default_processing_mode == "auto"      %}selected{% endif %}>Auto-detect</option>
        <option value="photo"     {% if default_processing_mode == "photo"     %}selected{% endif %}>Photo</option>
        <option value="drawing"   {% if default_processing_mode == "drawing"   %}selected{% endif %}>Drawing / Sketch</option>
        <option value="pixel_art" {% if default_processing_mode == "pixel_art" %}selected{% endif %}>Pixel art</option>
      </select>
    </div>

    <div class="mb-4">
      <span class="block text-xs text-gray-600 mb-1">Pattern type</span>
      <div class="flex gap-4">
        <label class="flex items-center gap-1.5 text-sm text-gray-700 cursor-pointer">
          <input type="radio" name="variant" value="color"
                 {% if default_variant != "bw" %}checked{% endif %}
                 class="accent-indigo-600" />
          Colour
        </label>
        <label class="flex items-center gap-1.5 text-sm text-gray-700 cursor-pointer">
          <input type="radio" name="variant" value="bw"
                 {% if default_variant == "bw" %}checked{% endif %}
                 class="accent-indigo-600" />
          Black &amp; White
        </label>
      </div>
    </div>

    <div class="mb-4">
      <span class="block text-xs text-gray-600 mb-1">Fabric settings</span>
      <div class="flex gap-2">
        <div class="flex-1">
          <label for="aida-count-{{ pid }}" class="block text-xs text-gray-400 mb-0.5">
            Aida count
          </label>
          <select
            id="aida-count-{{ pid }}"
            name="aida_count"
            class="w-full text-sm border border-gray-300 rounded-lg px-3 py-1.5
                   focus:outline-none focus:ring-1 focus:ring-indigo-500 bg-white">
            {% for ct in [11, 14, 16, 18, 20] %}
              <option value="{{ ct }}" {% if default_aida_count == ct %}selected{% endif %}>{{ ct }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="flex-1">
          <label for="margin-cm-{{ pid }}" class="block text-xs text-gray-400 mb-0.5">
            Margin (cm)
          </label>
          <input
            id="margin-cm-{{ pid }}"
            type="number"
            name="margin_cm"
            value="{{ default_margin_cm }}"
            min="0"
            step="0.1"
            class="w-full text-sm border border-gray-300 rounded-lg px-3 py-1.5
                   focus:outline-none focus:ring-1 focus:ring-indigo-500" />
        </div>
      </div>
    </div>

    <button
      id="generate-btn-{{ pid }}"
      type="submit"
      {% if not source_image_ref %}disabled{% endif %}
      class="w-full px-4 py-2 rounded-lg text-sm font-medium transition-colors
             {% if source_image_ref %}bg-indigo-600 text-white hover:bg-indigo-700
             {% else %}bg-gray-200 text-gray-400 cursor-not-allowed{% endif %}">
      Generate Pattern + PDF
    </button>

    {% if not source_image_ref %}
      <p class="text-xs text-amber-600 mt-1">Upload a source image first.</p>
    {% endif %}
  </form>
</div>
